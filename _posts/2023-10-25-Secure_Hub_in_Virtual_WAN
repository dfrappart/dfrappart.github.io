---
layout: post
title:  "Secure Hub in Azure Virtual WAN"
date:   2023-10-25 18:00:00 +0200
year: 2023
categories: Azure Network
---

Hi all!

This is the 2nd article about Azure Virtual WAN. 
This time we're going to look at the Secure Hub concepts, what it is about and what it brings to the table.
As for last time, we'll take a pragmatic approach and build our environment iteratively to illustrate the concepts.

Hope you'll enjoy it!

On the agenda today: 

1. Concepts:
- From Virtual Hub to Secure Hub
- Why Secure Hub. Use case for a centralized Firewall in the Cloud
- a look on the available options
2. Building a Secure Hub from scratch
- Building a hub
- adding a firewall to get a Secure Hub
- Configuring routing & Firewall rules
- Impact on Ingress flows in the spokes

With that being said, let's get started.

## 1. From Virtual Hub to Secure Hub

If you read the [Azure documentation about Virtual WAN](https://learn.microsoft.com/en-us/azure/virtual-wan/), or my l[ast article on this topic](https://blog.teknews.cloud/azure/network/2023/08/28/virtualwan101.html), you'll know that in a Virtual WAN based topology, we deploy inside (or is it on top ðŸ¤”) one or more virtual Hub. You probabply also now that a virtual Hub is a good solution to ease the East-West connectivity between Spokes thanks to the managed virtual routers that take care of route propagation in the vHub. All of this without using UDRs for routing, inside of spokes.

However, in this simple, yet efficient scenario, we lack option to filter traffic between those spokes, or from those spokes to other places which are not virtual network in Azure. Indeed, we can leverage Network Security Groups, but limitations do exist such as rules limited to L4, or Application Security Group only valid for intra spoke filtering.

**schemah&spokewithnsg**

One answer proposed by the Virtual WAN model is the use of a Secure Hub. In this scenario, a Network appliance is deployed inside the Virtual Hub and allows for a centralized Network filtering option. To be clear, **I am NOT** saying that NSGs should be removed in favor of a Hub Firewall only. Firstly because a Zero trust approach will prefer additional security layers (not taking into account the configuration management but that's clearly not the main topic here). Secondly, from a Spoke Vnet point of view, leaving the vnet to go through a firewall in the hub, to go back into the spoke would be strange to say the list from an network perspective. Hence local filtering in Spokes.
So, instead of a simple Hub & spokes, we get something similar to this:

**schemasecurehub**

There are probably questions regarding the routing configuration, but fear not, we'll tackle that in the last part of the article. Now we have a centralized firewall in our virtual hub, which change our hub to a secure hub
As mentioned, its use cases are to 

- managed network filtering between spokes
- provide additional capabilities such as L7 filtering
- provide an Internet breakout for spokes (Not to be forgotten since [default Internet access is going away from Azure](https://azure.microsoft.com/fr-fr/updates/default-outbound-access-for-vms-in-azure-will-be-retired-transition-to-a-new-method-of-internet-access/))

An interesting aspects is also this centralized property, which can be used to give a central Network team a point of control for everything that comes out of the spoke. Network flows management governance is not the heart of today's topic, but let's keep that in mind.

Otherwise, other capabilities can also be considered depending on the solution used.

Which bring us to the available options for the firewall, on which the capabilities will depend.

About that, it's always a good idea to remind ourselves of the **managed aspect** of the virtual hub. Because it's managed, there are less responsibilities on the customer part, but also less control. It means that the options for NVA are less rich than the Azure market place offer which... offers many dofferent options for NVA to be deployed in a self-managed Virtual NEtwork.

In a Virtual Hub, the first available option is the managed one, with Azure Firewall. 
Azure Firewall is a managed, zone redundant, appliance which can bring the filtering to the next level. Its native integration with Azure ease the automation implementation. Autmating an Azure Firewall deployment and configuration is done with the same tool used for Azure deployment and configuration. On the other hand, there are maybe not all the options that a 3rd party provider can deliver. 
One of those could be the Internet Ingress traffic, which is not a primary objective for Azure Firewall, except if coupled with an Azure WAF solution.

If some configuration are lacking, then it is possible to look at a 3rd party provider, as documented on the [Azure documentation](https://learn.microsoft.com/en-us/azure/virtual-wan/about-nva-hub#partners).
Currently, Security partner includes [CheckPoint](https://www.checkpoint.com/cloudguard/microsoft-azure-security/wan/) and [Fortigate](https://www.fortinet.com/products/next-generation-firewall) only. Other partners can be found but more on the SD WAN integration than the Firewalling options.

